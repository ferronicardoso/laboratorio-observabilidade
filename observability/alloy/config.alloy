logging {
  level = "info"
}

// Componente que envia logs para o Loki
loki.write "local" {
  endpoint {
    url = "http://loki:3100/loki/api/v1/push"
  }
}

// Monitora e lÃª os arquivos de log do Nginx
loki.source.file "nginx_logs" {
  targets = [
    {
      __path__ = "/var/log/nginx/access.log",
      job      = "nginx",
      type     = "access",
    },
    {
      __path__ = "/var/log/nginx/error.log",
      job      = "nginx",
      type     = "error",
    },
  ]

  forward_to = [loki.write.local.receiver]
}

// Receiver HTTP para Grafana Faro (RUM)
faro.receiver "frontend" {
  server {
    listen_address = "0.0.0.0"
    listen_port    = 12347
    cors_allowed_origins = ["*"]
  }

  output {
    logs   = [loki.write.local.receiver]
  }
}

// Coleta logs dos containers Docker (APIs) usando labels do Docker
discovery.relabel "api_containers" {
  targets = discovery.docker.api_containers.targets

  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/(.*)"
    target_label  = "container"
    replacement   = "$1"
  }

  rule {
    source_labels = ["__meta_docker_container_name"]
    regex         = "/(.*)"
    target_label  = "job"
    replacement   = "$1"
  }

  rule {
    source_labels = ["__meta_docker_container_label_com_docker_compose_service"]
    target_label  = "service"
  }
}

loki.source.docker "api_logs" {
  host       = "unix:///var/run/docker.sock"
  targets    = discovery.relabel.api_containers.output
  forward_to = [loki.write.local.receiver]
}

// Descobre containers Docker das APIs
discovery.docker "api_containers" {
  host = "unix:///var/run/docker.sock"

  filter {
    name   = "name"
    values = ["dotnet-api", "python-api", "java-api", "nextjs-app", "angular-app"]
  }
}
